require "eidas-saml"

class SamlSessionsController < Devise::SamlSessionsController
  after_action :store_winning_strategy, only: :create

  def new
    idp_entity_id = get_idp_entity_id(params)
    request = EidasSaml.new
    auth_params = { RelayState: relay_state } if relay_state
    action = request.create(saml_config(idp_entity_id), auth_params || {})
    redirect_to action
  end

  def eidas_endpoint
    require "XML_security_saml2"
    eidas_response = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHNhbWwycDpSZXNwb25zZSB4bWxuczpzYW1sMnA9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCIgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiIHhtbG5zOnNhbWwyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIiB4bWxuczpzdG9yaz0idXJuOmV1OnN0b3JrOm5hbWVzOnRjOlNUT1JLOjEuMDphc3NlcnRpb24iIHhtbG5zOnN0b3JrcD0idXJuOmV1OnN0b3JrOm5hbWVzOnRjOlNUT1JLOjEuMDpwcm90b2NvbCIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeG1sbnM6ZWlkYXM9Imh0dHA6Ly9laWRhcy5ldXJvcGEuZXUvYXR0cmlidXRlcy9uYXR1cmFscGVyc29uIiB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIENvbnNlbnQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpjb25zZW50Om9idGFpbmVkIiBEZXN0aW5hdGlvbj0iaHR0cHM6Ly9wcnVlYmFzLmV0c2l0LnVwbS5lcy9lcmFzbXVzL3VzZXJzL2VpZGFzL2F1dGgiIElEPSJfODZmYmI5ZDljMjBlOTRiYjAzMmQ2MzkwNTAyYTkxNTQiIEluUmVzcG9uc2VUbz0iXzkxYjJlNGI4LWJlOTMtNDVjZS05ZTg3LTM4NWY4YTE4OWE2NiIgSXNzdWVJbnN0YW50PSIyMDE4LTA5LTI3VDE0OjEzOjMyWiIgVmVyc2lvbj0iMi4wIj48c2FtbDI6SXNzdWVyIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOm5hbWVpZC1mb3JtYXQ6ZW50aXR5Ij5odHRwczovL2NsYXZlLXByZS5zaXIyLnJlZGlyaXMuZXMvZWlkYXMvbW9kdWxlLnBocC9jbGF2ZS9pZHAvbWV0YWRhdGEucGhwPC9zYW1sMjpJc3N1ZXI+PGRzOlNpZ25hdHVyZT4KICA8ZHM6U2lnbmVkSW5mbz48ZHM6Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPgogICAgPGRzOlNpZ25hdHVyZU1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZHNpZy1tb3JlI3JzYS1zaGEyNTYiLz4KICA8ZHM6UmVmZXJlbmNlIFVSST0iI184NmZiYjlkOWMyMGU5NGJiMDMyZDYzOTA1MDJhOTE1NCI+PGRzOlRyYW5zZm9ybXM+PGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIi8+PGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2Ii8+PGRzOkRpZ2VzdFZhbHVlPkliNExIZmM5Zy9OM3JULzAzcVNYajRRcno3N0t3S3lOL3dtNmpjaGFrRms9PC9kczpEaWdlc3RWYWx1ZT48L2RzOlJlZmVyZW5jZT48L2RzOlNpZ25lZEluZm8+PGRzOlNpZ25hdHVyZVZhbHVlPllmU3FETUFpMzZ6ckZ4bGJNcUJuVWk2VXhwL093Z2pBRTVURVBvU093aEFKT1MydVdxZE10NXhXOGFETmNzTEU5ZnNqd09zdU5URmdld2NnVk9zY1diMnhnYnRqdmF3c1plSEdaREgxWUlmY1pKTmNHMUsvTkJoaXJnS0txNWVvRk1yb1BXS1NXc1IvQ25ra1VuSEE3MGJkQVN6Q3RZdUdqUWJ4OThheitUZz08L2RzOlNpZ25hdHVyZVZhbHVlPgo8ZHM6S2V5SW5mbz48ZHM6WDUwOURhdGE+PGRzOlg1MDlDZXJ0aWZpY2F0ZT5NSUlET0RDQ0FxR2dBd0lCQWdJSkFNcVUrd3I2ei9sNU1BMEdDU3FHU0liM0RRRUJDd1VBTUlHME1SVXdFd1lLQ1pJbWlaUHlMR1FCR1JZRlkyeGhkbVV4RkRBU0Jnb0praWFKay9Jc1pBRVpGZ1J6YVhJeU1SY3dGUVlLQ1pJbWlaUHlMR1FCR1JZSGNtVmthWEpwY3pFU01CQUdDZ21TSm9tVDhpeGtBUmtXQW1Wek1SNHdIQVlEVlFRS0RCVmpiR0YyWlM1emFYSXlMbkpsWkdseWFYTXVaWE14R0RBV0JnTlZCQXNNRDBObGNuUnBabWxqWVdSdklGTlFWREVlTUJ3R0ExVUVBd3dWWTJ4aGRtVXVjMmx5TWk1eVpXUnBjbWx6TG1Wek1CNFhEVEUxTURrd01qRXhOVEkwTVZvWERUSTFNRGt3TVRFeE5USTBNVm93Z2JReEZUQVRCZ29Ka2lhSmsvSXNaQUVaRmdWamJHRjJaVEVVTUJJR0NnbVNKb21UOGl4a0FSa1dCSE5wY2pJeEZ6QVZCZ29Ka2lhSmsvSXNaQUVaRmdkeVpXUnBjbWx6TVJJd0VBWUtDWkltaVpQeUxHUUJHUllDWlhNeEhqQWNCZ05WQkFvTUZXTnNZWFpsTG5OcGNqSXVjbVZrYVhKcGN5NWxjekVZTUJZR0ExVUVDd3dQUTJWeWRHbG1hV05oWkc4Z1UxQlVNUjR3SEFZRFZRUUREQlZqYkdGMlpTNXphWEl5TG5KbFpHbHlhWE11WlhNd2daOHdEUVlKS29aSWh2Y05BUUVCQlFBRGdZMEFNSUdKQW9HQkFPdEJ1czh0eXgySkZINElMS1Jmdm5KK0V5YjBVRzF3T1ptMGhNdXRTME12TlF1dkJaVnl0UjhsVk1GcWxSWDdVMStGUDZPMTBjMkdEbml1b20zdjAxdXEyZ3VIbHU4b21SM1RqNTR5U0pmNHk3bTRiNDJpOGlVK3V5M1pLN3ZvUEhjeUIvektFRG5EeFZjNUttdGlvTHVrLzNNOU9meitYc2VkM3lDQ2ZNYjFBZ01CQUFHalVEQk9NQjBHQTFVZERnUVdCQlNTZTdTSlBUdFNMaStPYkFRRC84UWh2T1JVUHpBZkJnTlZIU01FR0RBV2dCU1NlN1NKUFR0U0xpK09iQVFELzhRaHZPUlVQekFNQmdOVkhSTUVCVEFEQVFIL01BMEdDU3FHU0liM0RRRUJDd1VBQTRHQkFGN01kNEdNbVBsOTJoVUJxMUxPT000Smw2Si9uSFNZTGtiM1NZdlFVeWlIT2NzVTJOYVhDZzZRbHJKZjlUK2tHM1hkQXY1NTBjTmhMdGtiaUYyc3RuUUJ5WDFPSFBZOWtJdWR5UTMvYzdESEZSZmkza2tCekw0VDFBR2RuOVB2enBRR3RETDNvd0xzSTNINXNtZmhBOEFwb2dKa0I1Qzdnemo2VTltMVpBWXo8L2RzOlg1MDlDZXJ0aWZpY2F0ZT48L2RzOlg1MDlEYXRhPjwvZHM6S2V5SW5mbz48L2RzOlNpZ25hdHVyZT48c2FtbDJwOlN0YXR1cz48c2FtbDJwOlN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6UmVzcG9uZGVyIj48c2FtbDJwOlN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6QXV0aG5GYWlsZWQiLz48L3NhbWwycDpTdGF0dXNDb2RlPjxzYW1sMnA6U3RhdHVzTWVzc2FnZT5udWxsIC0gTm8gc2UgaGEgcmVjaWJpZG8gZWwgY2VydGlmaWNhZG88L3NhbWwycDpTdGF0dXNNZXNzYWdlPjwvc2FtbDJwOlN0YXR1cz48c2FtbDI6RW5jcnlwdGVkQXNzZXJ0aW9uIHhtbG5zOnhlbmM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jIyI+PHhlbmM6RW5jcnlwdGVkRGF0YSB4bWxuczp4ZW5jPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyMiIHhtbG5zOmRzaWc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiIFR5cGU9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZW5jI0VsZW1lbnQiPjx4ZW5jOkVuY3J5cHRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNhZXMyNTYtY2JjIi8+PGRzOktleUluZm8geG1sbnM6ZHNpZz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PHhlbmM6RW5jcnlwdGVkS2V5Pjx4ZW5jOkVuY3J5cHRpb25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNyc2Etb2FlcC1tZ2YxcCIvPjx4ZW5jOkNpcGhlckRhdGE+PHhlbmM6Q2lwaGVyVmFsdWU+VkZpSWwybDVDWmRpd1pZc0phc0loN2dSdnFDRXdpL1kzMHBqSmFQR2xpVktPMnRGR3lRQjVKVHlZWlQzUmVrK0tyTEQwK2xtbkh3KzhPcFhRbG9HSmlxcE8xMjlJMGpKZzdSOFN3cFRaUUpVcHBUdDUyN2Fod1BGMUhwbkVxdnljZ0ZLdy9ML1Mwem9IVTZ1RUppakNrcjFKdGdla2hqd0ZTR2o4cXRtY0UxVmRhdnNsRnVLQUtIM2lja1ZMNHMzSEdlb3I5T0RTMUh0ZW9TMExxL2lwOWo2cXczYUlPSWM3dU1nRkQwMUk3eXU1UzI4MU10T2V4ajdrcDdOQ0NUcnloSkZUbmFZMlo1SlY2RlNNUStSREFOKy96RmtDYjUvaktQVElzOGZQK3liaHJBM1NTSEhNekdRMUJtK1oyUXV1Wmt3V3R1c3pEL2tiUkZWWVhHRlpRPT08L3hlbmM6Q2lwaGVyVmFsdWU+PC94ZW5jOkNpcGhlckRhdGE+PC94ZW5jOkVuY3J5cHRlZEtleT48L2RzOktleUluZm8+PHhlbmM6Q2lwaGVyRGF0YT48eGVuYzpDaXBoZXJWYWx1ZT5pMHdrVFVxSWhqcjBESWVUUk5VUmpTZ0hxVmdaeE1qWGlMeEJKQ0Zib2VYSE92OGp4UHAvWlZlckhvNHU0bkVaZ3RsODg0MHltR1J4VE9UdUZZa1BiTlFkc0h6OWxGQ0cyTlloZjJ1UzI2bDl3WkFoaHJDZTU4TzhsNVdSeWxobXJWNmR6VEJNTys1SE1Hc3RYY1dnbzVCK3h2bDNsbDE4TCtJcVZIcktNTzlKTmZ1TTRMa1QxNHJuTFBNSjlpYm1uM0VkUlMyZFdZNVBSMVJ6bjF5WCs0RkRFZitIYXN3cE9NMnMzRjMxNC96LzJxZnZCOVF0WnQyQzQxK2tkc2ZrMGozanVHaEU3QllGODRJcjU3YlFmcm14R0xUNkQ0bHQ2NEZyQXJOejBUSnZlNzFCc0ZCbHhyQXF2R0RiTDRIUExuRFNCaHNTYldDMDE0bWFFSHQyVHVpYVVvMDBndk9oYkxlYWN5aWNiNkEzYzBCVU1RYjA3ZmU3cEYrOUIyVDE2SUF5MC9qOVJLSHRvVGdLa3VrMElCV2VJN1hBdXZhWjNLK29iL28xNk5jRE5xdEw0UGd1UVhXV3dtQitENU4wYkNhYmh0UVJkVnVPSG56OW53R3ZGdkZtenJIZE0rMGwvanlrU003cy9kVlBXVDVoWW9TRHFqWGhrb3FFSzVLdURVWXB3NldCRVNEMHAwU0FUVWMwend3K2owV2JVeDF0SUVKYzQ5OTNlaGtpMFFhUG4zUllYM0o4SnRLVStLOEErUmtNeU1RNVNhQVBOYmZOU0x5R2h6WWVUalNnZEI4SUwwRE5OallMeGFUVTN1Rjd0UHJnZ1hiK2FJUTAxYWlsL3dGaFUrNERvWlczZ3NJeSt5SXJ5UmtHblpVczRWS1BjZ1d0S1NRa1JpdjdSd0ZLcEVMSkJmOWdvc1Rvd2lnc0hIUnF0bE0vMmpZUmovVkNTdFBuelZiVjBsd01VSjJ2NWNyQVBUUjNNVUE0Q2ZvMmVaSzhFcUhncG1FSzdHekZpZ2JUQUN0MEFsb1lOc2pQbHJ2bzNHbU5NbmR1YTJrRHhmcHhldUxaN1g1SzdnWDJnV2dCa2ZOZ1ppK1ZoUnNSZjJhb2xEYnlDYnhGVjByVW05TXBoNE1Sb1hVYVBLeWc3TDZqeUk5dVRaYWNYRzJsQzZGbnJtNjZaU3laamdWcmdHV2tESGd2YmVKWHk4N2tyYUdEN3J2OHF0SmxTbHhpZWFiTlhVRlNBWEdmUkptVVFpZE5TOVNCVFRTUENTL21aZnl4Nm9taDZpNlIyTzZZa0tZQUNZY0xuWVpqc0pINHFKemJ4bEZhUUQyejE0OGdxSlNVaHJLYTlZNWtPYWVONG50Q1pBNTE0NHcrdnkrT2xrL1JERUl3czY1aEFNRWZ3SS9MbW0xY1hsbFo3cW5TRHJwVW9NQlVoT3dMUWJ5alZvYzVaOXhRdWc5aWRIcFh4ZnB3aSs1dUx2M2xhcWZqb3d4aEd2MlpTUHhSNXc4L2xwYWxNd1VWZFNlcm95VlpuL0VKa0krY0NBYjYrQk96R05CMDQvNmQ0b0JCSXBsLzlOM1hNQVRHZmhQN2lqRHBBT1VYckVKK3ZwVUpRMlFFWUI3VEU5L3JYbGxKL2F2UHBNTXZBTWFGalRoSXM5UVlJbjZpWFA4dVplbmk1bXNhdFhlOVNoSVMwOHNaQmtNMXJNOWc3YkZETlJPSVozN3BtWk5KOWlmUm9ONUZpOXBlOHo4MjZXNjJ0VWU5UDZQanRodkRSb1RtOVdaTk5OeVUyWHdJbm10eC9GQzVwM2ZSMlBDNjk4K0JXcXNYR2xTS3hqai9VcVpZVTBtSWN5Ujg4Zi9nb2tVQmJvYUM0SjkwRDVkWGdIbTdQNnF5K3h0LzduU1lEVHJIM0xVV29YaG9OWWNoOGY3dzlSM3ZXeCsxVEI4NzRCV1hKQkxOMlNaeXc2a3JEZUVTbklDMHp5U1BKcGYva2M1YmtBajU1cDJmSUR4c3J5RnFrL3dKWG5Mc0xiaXNwUHhDbEFNeGFkUTFRNkJEc3hYa3VwYzNkTElTelBkUnAwdE1SQzcvZWpnV0lkRTlQd0Fsb1JzeDVZdjhRV3B0WmpkdXA2NlV1TE1VRmxDSi96RnNKai92ZUZLVkRsUGQvL0R1WGhZdmNJK21pUjRxSWFuMVBDVlJWSjRTdXZQRThkTFh2QWwycWFBVnA2SU02U2tpNmswZEJtSjhweUkrWlJYWjJ4clFCMVUveWhTREJBNHJQOWhwM2Y2dE45SzF3cVNmcnpGWWUzRStXOExuNmY2Sk4yYjdQM1NaUVY5Q1ZDNzFwSjdqWkxVazdYL1ZrdlNtSExNRFVFNEpRSzhvWmJnY1FuQVpWNlM2Mmp3cGRaTXZqOXUyQ01lNHg0WDJ0Slc1b0pYWnpHTW9qa09jZzFLRS9oak5PMVFJOG9RbStCQTY0Zm9TTEI2RjwveGVuYzpDaXBoZXJWYWx1ZT48L3hlbmM6Q2lwaGVyRGF0YT48L3hlbmM6RW5jcnlwdGVkRGF0YT48L3NhbWwyOkVuY3J5cHRlZEFzc2VydGlvbj48L3NhbWwycDpSZXNwb25zZT4K"
    XMLSecuritySAML2.decypher_document(File.read(Rails.root + 'vendor/certs/key.pem'), eidas_response)
  end

  def metadata
     xml = File.read("#{Rails.root}/public/metadata.xml")
	   render :plain=> xml, :content_type=> "application/xml"
  end

  private

  def store_winning_strategy
    warden.session(:user)[:strategy] = warden.winning_strategies[:user].class.name.demodulize.underscore.to_sym
  end
end